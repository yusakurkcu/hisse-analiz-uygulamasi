import streamlit as st
import yfinance as yf
import pandas as pd
import pandas_ta as ta
import plotly.graph_objects as go
from datetime import datetime, timedelta
import requests

# ==================================================================================================
# TEMEL AYARLAR VE STƒ∞L YAPILANDIRMASI
# ==================================================================================================

st.set_page_config(
    page_title="Borsa Fƒ±rsat Tarama Botu",
    page_icon="üêÇ",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Robinhood'dan ilham alan modern koyu tema i√ßin √∂zel CSS
st.markdown("""
<style>
    /* Google Fonts'tan Inter yazƒ± tipini y√ºkle */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* Genel Stil Ayarlarƒ± */
    body, .stApp {
        font-family: 'Inter', sans-serif;
        background-color: #000000;
        color: #FAFAFA;
    }
    
    /* Ana Ba≈ülƒ±k Stili */
    .stApp > header {
        background-color: transparent;
    }
    
    .css-18ni7ap {
        background: #000000;
    }

    /* Sekme Stilleri */
    .stTabs [data-baseweb="tab-list"] {
        gap: 24px;
        border-bottom: 1px solid #262626;
    }

    .stTabs [data-baseweb="tab"] {
        height: 50px;
        white-space: pre-wrap;
        background-color: transparent;
        border-radius: 4px 4px 0px 0px;
        gap: 8px;
        padding-top: 10px;
        padding-bottom: 10px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
    }

    .stTabs [aria-selected="true"] {
        background-color: #101010;
        color: #22c55e; /* Vurgu Rengi - Canlƒ± Ye≈üil */
        border-bottom: 2px solid #22c55e;
    }
    
    /* Kart (Expander) Stilleri */
    .st-expander, .streamlit-expander {
        border: 1px solid #262626;
        border-radius: 12px;
        background-color: #101010;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .st-expander header, .streamlit-expander-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #FAFAFA;
        padding: 16px;
    }
    
    .st-expander:hover, .streamlit-expander:hover {
       border-color: #22c55e;
    }

    /* Buton Stilleri */
    .stButton>button {
        border-radius: 8px;
        background-color: #22c55e;
        color: #000000;
        border: none;
        padding: 12px 24px;
        font-weight: 700;
        font-size: 1rem;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        transition: all 0.2s ease-in-out;
    }
    .stButton>button:hover {
        background-color: #16a34a;
        transform: scale(1.02);
    }
    
    /* Metin Giri≈ü Kutusu Stilleri */
    .stTextInput>div>div>input {
        border-radius: 8px;
        background-color: #101010;
        border: 1px solid #363636;
        color: #FAFAFA;
    }
    
    /* Metrik Kutularƒ± Stili */
    div[data-testid="stMetric"] {
        background-color: #101010;
        border: 1px solid #262626;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Logo ve Ba≈ülƒ±k Stili */
    .app-header {
        display: flex;
        align-items: center;
        gap: 15px;
        padding-bottom: 20px;
        border-bottom: 1px solid #262626;
        margin-bottom: 20px;
    }
    .app-header .logo {
        font-size: 2.5rem;
    }
    .app-header .title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #FAFAFA;
    }

</style>
""", unsafe_allow_html=True)


# ==================================================================================================
# YARDIMCI FONKSƒ∞YONLAR
# ==================================================================================================

# yfinance'dan gelen verilerin s√ºtun adlarƒ±nƒ± standartla≈ütƒ±rmak i√ßin
def standardize_columns(df):
    """Veri √ßer√ßevesindeki s√ºtun adlarƒ±nƒ± k√º√ß√ºk harfe √ßevirir."""
    df.columns = df.columns.str.lower()
    return df

@st.cache_data(ttl=3600)
def get_stock_info(ticker):
    """Bir hisse senedinin temel bilgilerini ve logosunu √ßeker."""
    try:
        stock = yf.Ticker(ticker)
        info = stock.info
        logo_url = info.get('logo_url', '')
        # Logo URL'si yoksa veya bo≈üsa, favicon kullanmayƒ± dene
        if not logo_url:
            domain = info.get('website', '').split('//')[-1].split('/')[0]
            if domain:
                logo_url = f"https://logo.clearbit.com/{domain}"
        return info, logo_url
    except Exception as e:
        return None, ""

@st.cache_data(ttl=900)
def get_stock_data(ticker, period="1y"):
    """Belirtilen periyotta hisse senedi verilerini √ßeker ve standartla≈ütƒ±rƒ±r."""
    try:
        stock = yf.Ticker(ticker)
        df = stock.history(period=period)
        if df.empty:
            return None
        return standardize_columns(df)
    except Exception as e:
        return None
        
@st.cache_data(ttl=3600)
def get_robinhood_stocks():
    """Robinhood'da i≈ülem g√∂ren pop√ºler hisselerin bir listesini √ßeker."""
    # G√ºvenilir bir kaynaktan alƒ±nmƒ±≈ü statik liste.
    # Bu liste zamanla g√ºncellenebilir.
    tickers = [
        'AAPL', 'MSFT', 'AMZN', 'GOOGL', 'GOOG', 'TSLA', 'META', 'NVDA', 'BRK-B', 'JPM', 'JNJ', 'V', 'UNH',
        'WMT', 'PG', 'MA', 'HD', 'DIS', 'BAC', 'PYPL', 'NFLX', 'ADBE', 'CRM', 'PFE', 'KO', 'INTC', 'CMCSA',
        'PEP', 'XOM', 'CSCO', 'T', 'VZ', 'ABT', 'NKE', 'MCD', 'MDT', 'WFC', 'COST', 'AVGO', 'ACN', 'QCOM',
        'TMO', 'CVX', 'LLY', 'MRK', 'NEE', 'DHR', 'TXN', 'HON', 'UPS', 'PM', 'ORCL', 'UNP', 'LIN', 'SBUX',
        'LOW', 'AMD', 'IBM', 'BA', 'CAT', 'GS', 'RTX', 'MMM', 'GE', 'CVS', 'DE', 'AMGN', 'ISRG', 'BKNG',
        'GILD', 'AMT', 'SPGI', 'ZTS', 'MO', 'ANTM', 'C', 'CI', 'TJX', 'TGT', 'BDX', 'SYK', 'ADP', 'FIS',
        'SCHW', 'DUK', 'PLD', 'SO', 'USB', 'LMT', 'CB', 'NOW', 'FISV', 'AXP', 'ETN', 'MDLZ', 'PNC', 'CL',
        'INTU', 'ADI', 'NSC', 'ATVI', 'ICE', 'MMC', 'BIIB', 'BSX', 'GM', 'F'
    ]
    return tickers

def run_breakout_scan(tickers):
    """
    Belirtilen hisseler √ºzerinde y√ºksek hacimli kƒ±rƒ±lƒ±m stratejisini √ßalƒ±≈ütƒ±rƒ±r.
    """
    results = []
    progress_bar = st.progress(0)
    status_text = st.empty()

    for i, ticker in enumerate(tickers):
        try:
            status_text.text(f"üîé {ticker} taranƒ±yor... ({i+1}/{len(tickers)})")
            
            stock_info, _ = get_stock_info(ticker)
            if stock_info is None:
                continue
            
            # 1. Piyasa Deƒüeri Filtresi
            market_cap = stock_info.get('marketCap', 0)
            if market_cap < 500_000_000:
                continue

            df = get_stock_data(ticker, period="250d")
            if df is None or len(df) < 200:
                continue

            # Teknik g√∂stergeleri hesapla
            df.ta.sma(length=200, append=True)
            df.ta.atr(length=14, append=True)
            
            latest_price = df['close'].iloc[-1]
            latest_volume = df['volume'].iloc[-1]
            sma_200 = df['SMA_200'].iloc[-1]
            atr = df['ATRr_14'].iloc[-1]

            # 2. Uzun Vadeli Y√ºkseli≈ü Trendi
            if latest_price < sma_200:
                continue

            # Son 20 g√ºnl√ºk veriyi al
            last_20_days = df.iloc[-21:-1]
            
            # 3. Sƒ±kƒ±≈üma D√∂nemi
            max_20_days = last_20_days['high'].max()
            min_20_days = last_20_days['low'].min()
            
            if (max_20_days - min_20_days) / min_20_days > 0.15:
                continue
            
            # 4. Kƒ±rƒ±lƒ±m Anƒ±
            if latest_price < max_20_days:
                continue
                
            # 5. Hacim Teyidi
            avg_volume_20_days = last_20_days['volume'].mean()
            if latest_volume < (avg_volume_20_days * 1.5):
                continue
            
            # T√ºm ko≈üullar saƒülandƒ±, sonucu listeye ekle
            potential = (df['ATR_14'].iloc[-1] * 2 / latest_price) * 100
            target_price = latest_price + (df['ATR_14'].iloc[-1] * 2)

            results.append({
                'ticker': ticker,
                'info': stock_info,
                'potential': potential,
                'target_price': target_price,
                'latest_price': latest_price
            })

        except Exception as e:
            # Hata olu≈üursa atla ve devam et
            continue
        finally:
            progress_bar.progress((i + 1) / len(tickers))

    status_text.success(f"‚úÖ Tarama tamamlandƒ±! {len(results)} fƒ±rsat bulundu.")
    progress_bar.empty()
    return results

def get_technical_analysis(df):
    """RSI, MACD ve SMA'ya dayalƒ± basit bir teknik analiz √∂nerisi olu≈üturur."""
    if df is None or len(df) < 50:
        return "N√ñTR", "Yetersiz veri."

    # G√∂stergeleri hesapla
    df.ta.rsi(length=14, append=True)
    df.ta.macd(fast=12, slow=26, signal=9, append=True)
    df.ta.sma(length=50, append=True)
    df.ta.sma(length=200, append=True)
    
    latest = df.iloc[-1]
    score = 0
    
    # RSI
    if latest['RSI_14'] < 30: score += 2
    elif latest['RSI_14'] < 40: score += 1
    elif latest['RSI_14'] > 70: score -= 2
    elif latest['RSI_14'] > 60: score -= 1
        
    # MACD
    if latest['MACD_12_26_9'] > latest['MACDs_12_26_9']: score += 1
    else: score -=1
    
    # Hareketli Ortalamalar
    if latest['close'] > latest['SMA_50']: score += 1
    if latest['close'] > latest['SMA_200']: score += 1
    if latest['SMA_50'] > latest['SMA_200']: score += 1
    
    # Sonu√ß
    if score >= 3:
        return "AL", "Hisse, RSI, MACD ve hareketli ortalamalara dayalƒ± olarak pozitif bir momentum sergiliyor. Y√ºkseli≈ü trendi sinyalleri g√º√ßl√º."
    elif score <= -2:
        return "SAT", "Teknik g√∂stergeler zayƒ±flƒ±ƒüa i≈üaret ediyor. D√º≈ü√º≈ü momentumu ve negatif sinyaller mevcut."
    else:
        return "N√ñTR", "Piyasa kararsƒ±z bir seyir izliyor. Belirgin bir alƒ±m veya satƒ±m sinyali ≈üu an i√ßin g√∂zlenmiyor."

@st.cache_data(ttl=900)
def get_smart_option(ticker, stock_price):
    """
    Belirtilen hisse i√ßin en mantƒ±klƒ± alƒ±m (Call) opsiyonunu bulur.
    """
    try:
        stock = yf.Ticker(ticker)
        exp_dates = stock.options
        
        today = datetime.now()
        min_exp = today + timedelta(days=30)
        max_exp = today + timedelta(days=45)

        suitable_contracts = []

        for date in exp_dates:
            exp_date = datetime.strptime(date, '%Y-%m-%d')
            if not (min_exp <= exp_date <= max_exp):
                continue

            option_chain = stock.option_chain(date)
            calls = option_chain.calls
            
            # Filtreleme
            calls = calls[calls['openInterest'] > 50] # Likidite
            calls['spread'] = calls['ask'] - calls['bid']
            calls = calls[calls['spread'] < 0.5] # Dar makas
            calls = calls[calls['ask'] < (stock_price * 0.10)] # Maliyet
            
            # Fiyata en yakƒ±n olanlarƒ± se√ß
            calls = calls[(calls['strike'] > stock_price * 0.95) & (calls['strike'] < stock_price * 1.10)]
            
            if not calls.empty:
                suitable_contracts.append(calls)
        
        if not suitable_contracts:
            return None
            
        all_options = pd.concat(suitable_contracts)
        
        # En ucuz olanƒ± se√ß
        best_option = all_options.loc[all_options['ask'].idxmin()]
        return best_option

    except Exception as e:
        return None

# ==================================================================================================
# UYGULAMA ARAY√úZ√ú
# ==================================================================================================

# Header
st.markdown("""
<div class="app-header">
    <span class="logo">üêÇ</span>
    <span class="title">Borsa Fƒ±rsat Tarama Botu</span>
</div>
""", unsafe_allow_html=True)


# Sekmeler
tab1, tab2 = st.tabs(["üìà Fƒ±rsat Taramasƒ±", "üîç Hisse Analizi"])

# --------------------------------------------------------------------------------------------------
# SEKME 1: FIRSAT TARAMASI
# --------------------------------------------------------------------------------------------------
with tab1:
    st.subheader("Y√ºksek Hacimli Kƒ±rƒ±lƒ±m Stratejisi")
    st.markdown("Bu ara√ß, uzun vadeli y√ºkseli≈ü trendinde olan, bir s√ºredir dar bir bantta sƒ±kƒ±≈ümƒ±≈ü ve bu sƒ±kƒ±≈ümayƒ± y√ºksek hacimle yukarƒ± kƒ±rmƒ±≈ü hisseleri tespit eder. Sadece piyasa deƒüeri **500 Milyon Dolar**'dan b√ºy√ºk ≈üirketler listelenir.")

    if 'scan_results' not in st.session_state:
        st.session_state.scan_results = None

    if st.button("üöÄ Taramayƒ± Ba≈ülat"):
        with st.spinner("Piyasalar taranƒ±yor, l√ºtfen bekleyin... Bu i≈ülem birka√ß dakika s√ºrebilir."):
            tickers_to_scan = get_robinhood_stocks()
            st.session_state.scan_results = run_breakout_scan(tickers_to_scan)

    if st.session_state.scan_results is not None:
        results = st.session_state.scan_results
        
        if not results:
            st.info("Mevcut piyasa ko≈üullarƒ±nda stratejiye uygun hisse bulunamadƒ±.")
        else:
            st.success(f"**{len(results)} adet potansiyel fƒ±rsat bulundu!**")
            
            for res in results:
                info = res['info']
                ticker = res['ticker']
                _, logo_url = get_stock_info(ticker)
                
                header_col1, header_col2 = st.columns([1, 5])
                with header_col1:
                    if logo_url:
                        st.image(logo_url, width=60)
                    else:
                        st.markdown(f'<div style="width:60px; height:60px; background-color:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.5rem;">{ticker[0]}</div>', unsafe_allow_html=True)
                with header_col2:
                    st.write(f"**{info.get('shortName', ticker)} ({ticker})**")
                    st.markdown(f"**<span style='color:#22c55e;'>Potansiyel: +{res['potential']:.2f}%</span>**", unsafe_allow_html=True)
                
                with st.expander("Detaylarƒ± G√∂r√ºnt√ºle", expanded=False):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.markdown("##### Teyit Sinyalleri")
                        st.success("‚úÖ Fiyat > 200 G√ºnl√ºk Ortalama")
                        st.success("‚úÖ Son 20 G√ºnl√ºk Sƒ±kƒ±≈üma")
                        st.success("‚úÖ Fiyat Kƒ±rƒ±lƒ±mƒ± Ger√ßekle≈üti")
                        st.success("‚úÖ Hacim Ortalamanƒ±n 1.5 Katƒ±")
                        st.success("‚úÖ Piyasa Deƒüeri > $500M")

                    with col2:
                        st.markdown("##### Hedef ve Potansiyel Kazan√ß")
                        st.metric(
                            label="ATR (14) Bazlƒ± Hedef Fiyat",
                            value=f"${res['target_price']:.2f}",
                            delta=f"+${res['target_price'] - res['latest_price']:.2f}"
                        )
                        
                        st.markdown("<hr style='border-color: #262626; margin-top: 20px; margin-bottom: 20px;'>", unsafe_allow_html=True)

                        st.markdown("##### Yatƒ±rƒ±m Hesaplayƒ±cƒ±")
                        investment_amount = st.number_input("Yatƒ±rƒ±m Miktarƒ± ($)", min_value=100, max_value=100000, value=1000, step=100, key=f"invest_{ticker}")
                        
                        num_shares = investment_amount / res['latest_price']
                        potential_profit = (res['target_price'] - res['latest_price']) * num_shares
                        
                        st.info(f"**{investment_amount}$** yatƒ±rƒ±m ile hedefe ula≈üƒ±ldƒ±ƒüƒ±nda potansiyel k√¢rƒ±nƒ±z **~${potential_profit:.2f}** olabilir.")

# --------------------------------------------------------------------------------------------------
# SEKME 2: Hƒ∞SSE ANALƒ∞Zƒ∞
# --------------------------------------------------------------------------------------------------
with tab2:
    st.subheader("Detaylƒ± Hisse Senedi Analizi")
    
    ticker_input = st.text_input(
        "Analiz etmek istediƒüiniz hisse senedi sembol√ºn√º girin (√ñrn: AAPL, TSLA, MSFT)",
        placeholder="Sembol√º buraya yazƒ±n..."
    ).upper()

    if ticker_input:
        with st.spinner(f"{ticker_input} verileri analiz ediliyor..."):
            info, logo_url = get_stock_info(ticker_input)
            df = get_stock_data(ticker_input, "1y")

            if info is None or df is None:
                st.error("Hisse senedi bilgileri alƒ±namadƒ±. L√ºtfen sembol√º kontrol edin.")
            else:
                st.markdown("---")
                
                # Ba≈ülƒ±k ve Logo
                col1, col2 = st.columns([1, 6])
                with col1:
                    if logo_url:
                        st.image(logo_url, width=80)
                    else:
                         st.markdown(f'<div style="width:80px; height:80px; background-color:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:2rem;">{ticker_input[0]}</div>', unsafe_allow_html=True)
                with col2:
                    st.title(info.get('shortName', ticker_input))
                    st.subheader(f"{info.get('symbol', '')} - {info.get('exchange', '')}")

                st.markdown("---")
                
                # Temel Metrikler
                st.subheader("Genel Bakƒ±≈ü")
                latest_price = df['close'].iloc[-1]
                prev_close = df['close'].iloc[-2]
                price_change = latest_price - prev_close
                price_change_pct = (price_change / prev_close) * 100
                
                # Teknik Analiz
                analysis_signal, analysis_text = get_technical_analysis(df)
                
                # Dinamik Fiyat Beklentisi
                atr_val = ta.atr(df['high'], df['low'], df['close'], length=14).iloc[-1]
                if analysis_signal == "SAT":
                    target_delta = -atr_val * 1.5
                    target_price = latest_price + target_delta
                else:
                    target_delta = atr_val * 2
                    target_price = latest_price + target_delta
                
                # Destek & Diren√ß
                last_90_days = df.tail(90)
                support_1 = last_90_days['low'].min()
                resistance_1 = last_90_days['high'].max()

                m_col1, m_col2, m_col3, m_col4 = st.columns(4)
                with m_col1:
                    st.metric(
                        label="G√ºncel Fiyat",
                        value=f"${latest_price:.2f}",
                        delta=f"{price_change:.2f} ({price_change_pct:.2f}%)"
                    )
                with m_col2:
                    market_cap = info.get('marketCap', 0)
                    st.metric(label="Piyasa Deƒüeri", value=f"${market_cap/1e9:.2f} Milyar")
                with m_col3:
                    st.metric(
                        label="Dinamik Fiyat Beklentisi",
                        value=f"${target_price:.2f}",
                        delta=f"{target_delta/latest_price*100:.2f}%",
                        help="Teknik analize g√∂re hesaplanan, 14 g√ºnl√ºk ortalama volatilite (ATR) kullanƒ±larak olu≈üturulmu≈ü kƒ±sa vadeli fiyat hedefidir. AL/N√ñTR i√ßin ATR*2, SAT i√ßin ATR*1.5 kullanƒ±lƒ±r."
                    )
                with m_col4:
                    st.metric(label="Teknik Sinyal", value=analysis_signal)
                
                st.markdown("---")
                
                # Grafik ve Analiz Detaylarƒ±
                st.subheader("Teknik Analiz ve Fiyat Grafiƒüi")
                g_col1, g_col2 = st.columns([2, 3])
                
                with g_col1:
                    st.markdown("##### Analiz D√∂k√ºm√º")
                    st.info(analysis_text)
                    
                    st.markdown("##### Destek & Diren√ß")
                    st.markdown(f"**Diren√ß 1 (R1 - 90 G√ºn Zirve):** `${resistance_1:.2f}`")
                    st.markdown(f"**Destek 1 (S1 - 90 G√ºn Dip):** `${support_1:.2f}`")

                    st.markdown("##### ≈ûirket Profili")
                    st.write(info.get('longBusinessSummary', 'Profil bilgisi bulunamadƒ±.'))
                    
                with g_col2:
                    fig = go.Figure(data=[go.Candlestick(x=df.index,
                                    open=df['open'],
                                    high=df['high'],
                                    low=df['low'],
                                    close=df['close'])])

                    # Destek ve Diren√ß √ßizgileri
                    fig.add_hline(y=resistance_1, line_dash="dash", line_color="#ef4444", annotation_text="Diren√ß 1 (R1)", annotation_position="bottom right")
                    fig.add_hline(y=support_1, line_dash="dash", line_color="#22c55e", annotation_text="Destek 1 (S1)", annotation_position="bottom right")

                    fig.update_layout(
                        title=f'{ticker_input} Fiyat Grafiƒüi',
                        yaxis_title='Fiyat ($)',
                        xaxis_rangeslider_visible=False,
                        template='plotly_dark',
                        plot_bgcolor='#101010',
                        paper_bgcolor='#101010',
                        font=dict(family="Inter, sans-serif", color="#FAFAFA")
                    )
                    st.plotly_chart(fig, use_container_width=True)

                st.markdown("---")
                
                # Akƒ±llƒ± Opsiyon √ñnerisi
                st.subheader("üí° Akƒ±llƒ± Opsiyon √ñnerisi")
                with st.spinner("En uygun opsiyon kontratƒ± aranƒ±yor..."):
                    best_option = get_smart_option(ticker_input, latest_price)
                
                if best_option is not None:
                    o_col1, o_col2, o_col3, o_col4 = st.columns(4)
                    exp_date = datetime.fromtimestamp(best_option['expiration']).strftime('%d %B %Y')
                    
                    o_col1.metric("Vade Tarihi", exp_date)
                    o_col2.metric("Kullanƒ±m Fiyatƒ± (Strike)", f"${best_option['strike']:.2f}")
                    o_col3.metric("Kontrat Primi (Maliyet)", f"${best_option['ask']:.2f}")
                    o_col4.metric("A√ßƒ±k Pozisyon", f"{best_option['openInterest']:.0f}")

                    st.info(f"Bu Alƒ±m (Call) opsiyonu; 30-45 g√ºn arasƒ± vadesi, y√ºksek likiditesi, dar alƒ±m-satƒ±m makasƒ± ve hisse fiyatƒ±na oranla makul maliyeti nedeniyle se√ßilmi≈ütir. Bu bir yatƒ±rƒ±m tavsiyesi deƒüildir.")
                else:
                    st.warning("Bu hisse i√ßin belirtilen kriterlere (30-45 g√ºn vade, yeterli likidite, d√º≈ü√ºk maliyet) uygun bir opsiyon kontratƒ± bulunamadƒ±.")
